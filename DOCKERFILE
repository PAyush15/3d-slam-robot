# =============================================================
# Custom ROS2 image for Jetson - based on Dusty's prebuilt base
# Fixes all expired key/signature issues permanently
# =============================================================

FROM dustynv/ros:humble-desktop-l4t-r36.4.0

ENV DEBIAN_FRONTEND=noninteractive
SHELL ["/bin/bash", "-lc"]

# --- 🔧 STEP 1: Fix all expired Ubuntu & ROS keys ---
RUN set -eux; \
    apt-get update; \
    apt-get install -y --no-install-recommends ca-certificates curl gnupg2; \
    # remove any old ROS keyrings/sources that may have expired
    rm -f /etc/apt/sources.list.d/*ros* /etc/apt/trusted.gpg.d/ros*.gpg /usr/share/keyrings/ros-archive-keyring.gpg || true; \
    # fetch and install the new ROS keyring
    curl -fsSL https://raw.githubusercontent.com/ros/rosdistro/master/ros.key \
        | gpg --dearmor -o /usr/share/keyrings/ros-archive-keyring.gpg; \
    # add the ROS 2 repository (Ubuntu 22.04 = jammy)
    echo "deb [arch=arm64 signed-by=/usr/share/keyrings/ros-archive-keyring.gpg] \
    http://packages.ros.org/ros2/ubuntu jammy main" \
        > /etc/apt/sources.list.d/ros2.list; \
    # refresh lists
    rm -rf /var/lib/apt/lists/*; \
    apt-get update

# --- 🧰 STEP 2: Install development and ROS build tools ---
RUN apt-get install -y --no-install-recommends \
    build-essential cmake git wget nano \
    python3-pip python3-vcstool python3-colcon-common-extensions \
    python3-rosdep python3-argcomplete \
    && rm -rf /var/lib/apt/lists/*

# --- 🔄 STEP 3: Initialize rosdep ---
RUN rosdep init || true && rosdep update

# --- 🏗️ STEP 4: Create a clean ROS workspace ---
RUN mkdir -p /root/ros2_ws/src
WORKDIR /root/ros2_ws

# --- ⚙️ STEP 5: Auto-source environment on container start ---
RUN echo 'source /opt/ros/humble/setup.bash' >> /root/.bashrc && \
    echo 'if [ -f /root/ros2_ws/install/setup.bash ]; then source /root/ros2_ws/install/setup.bash; fi' >> /root/.bashrc

CMD ["/bin/bash"]
